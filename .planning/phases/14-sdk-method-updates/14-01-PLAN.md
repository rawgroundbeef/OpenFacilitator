---
phase: 14-sdk-method-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/sdk/src/client.ts
  - packages/sdk/src/utils.ts
autonomous: true

must_haves:
  truths:
    - "verify() accepts v1 payloads and returns VerifyResponse"
    - "verify() accepts v2 payloads and returns VerifyResponse"
    - "settle() accepts v1 payloads and returns SettleResponse"
    - "settle() accepts v2 payloads and returns SettleResponse"
    - "Missing x402Version treated as v1 (backward compatibility)"
    - "Unsupported x402Version throws clear error with version number"
    - "SDK builds successfully with pnpm --filter=@openfacilitator/sdk build"
  artifacts:
    - path: "packages/sdk/src/client.ts"
      provides: "verify() and settle() with version validation"
      contains: "getVersionSafe"
    - path: "packages/sdk/src/utils.ts"
      provides: "getVersionSafe utility for backward-compatible version detection"
      exports: ["getVersionSafe"]
  key_links:
    - from: "packages/sdk/src/client.ts"
      to: "packages/sdk/src/utils.ts"
      via: "import getVersionSafe"
      pattern: "import.*getVersionSafe.*from.*utils"
---

<objective>
Add version validation with backward compatibility to verify() and settle() methods

Purpose: SDK methods need to handle pre-versioning payloads (missing x402Version) as v1, and throw clear errors for unsupported versions. The current implementation passes payloads through without validation - this adds defensive version handling per CONTEXT.md decisions.

Output: Updated client.ts with version validation in verify/settle, new getVersionSafe utility exported from utils.ts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-sdk-method-updates/14-CONTEXT.md
@.planning/phases/14-sdk-method-updates/14-RESEARCH.md

# Prior phase context
@.planning/phases/13-sdk-type-guards-utilities/13-01-SUMMARY.md

# Key files
@packages/sdk/src/client.ts
@packages/sdk/src/utils.ts
@packages/sdk/src/types.ts
@packages/sdk/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getVersionSafe utility for backward-compatible version detection</name>
  <files>packages/sdk/src/utils.ts, packages/sdk/src/index.ts</files>
  <action>
Add a new utility function `getVersionSafe` to utils.ts that:
1. Accepts `unknown` input (like other guards) for maximum safety
2. Returns `1 | 2` if version is valid (1 or 2)
3. Returns `1` if x402Version is undefined/missing (backward compatibility)
4. Throws descriptive error if version is present but not 1 or 2: "Unsupported x402 version: X. SDK supports versions 1 and 2."

Implementation pattern (from RESEARCH.md):
```typescript
export function getVersionSafe(payment: unknown): 1 | 2 {
  if (!payment || typeof payment !== 'object') {
    return 1; // Backward compat: missing payload treated as v1
  }
  const obj = payment as Record<string, unknown>;
  const version = obj.x402Version;
  if (version === undefined) return 1; // Backward compat
  if (version === 1 || version === 2) return version;
  throw new Error(`Unsupported x402 version: ${version}. SDK supports versions 1 and 2.`);
}
```

Export from index.ts in the Utils section (alphabetically between getSchemeNetwork and getVersion).

Do NOT modify the existing getVersion function - it assumes a valid PaymentPayload union and is for internal use after validation. getVersionSafe is the entry-point validator.
  </action>
  <verify>
1. Run `pnpm --filter=@openfacilitator/sdk build` - should succeed
2. Grep for "getVersionSafe" in index.ts - should be exported
3. Grep for "Unsupported x402 version" in utils.ts - error message present
  </verify>
  <done>
- getVersionSafe exported from @openfacilitator/sdk
- Returns 1 for missing/undefined version
- Returns 1 or 2 for valid versions
- Throws descriptive error for invalid versions
  </done>
</task>

<task type="auto">
  <name>Task 2: Add version validation to verify() and settle() methods</name>
  <files>packages/sdk/src/client.ts</files>
  <action>
Update verify() and settle() in client.ts to call getVersionSafe at method entry for version validation.

Changes to verify():
1. Import getVersionSafe from utils.js
2. At the start of the try block (before constructing body), call: `const version = getVersionSafe(payment);`
3. Use the validated version in the body: `x402Version: version` (instead of `payment.x402Version`)

Changes to settle():
1. Same pattern as verify() - call getVersionSafe at method entry
2. Use validated version in body

This ensures:
- Missing x402Version defaults to 1 (backward compat)
- Invalid versions throw before any network request
- Consistent error handling in both methods

Do NOT change the method signatures - they still accept PaymentPayload union. The validation happens at runtime for pre-versioning payloads that don't have x402Version.

Pattern from existing code (preserve error handling structure):
```typescript
async verify(payment: PaymentPayload, requirements: PaymentRequirements): Promise<VerifyResponse> {
  try {
    const version = getVersionSafe(payment);
    const body = {
      x402Version: version,
      paymentPayload: payment,
      paymentRequirements: requirements,
    };
    // ... rest unchanged
  } catch (error) {
    // ... existing error handling
  }
}
```
  </action>
  <verify>
1. Run `pnpm --filter=@openfacilitator/sdk build` - should succeed
2. Grep for "getVersionSafe" in client.ts - should appear in verify() and settle()
3. Run `pnpm --filter=@openfacilitator/sdk test` if tests exist - should pass
  </verify>
  <done>
- verify() validates version at entry using getVersionSafe
- settle() validates version at entry using getVersionSafe
- Missing x402Version in payloads defaults to v1
- Invalid versions throw before network requests
- SDK builds successfully
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `pnpm --filter=@openfacilitator/sdk build` succeeds
2. `getVersionSafe` exported from package index
3. `verify()` and `settle()` use getVersionSafe for version validation
4. Backward compatibility: payloads without x402Version treated as v1
</verification>

<success_criteria>
Phase 14 requirements complete:
- SDK-07: All new types exported (done in Phase 13, verified)
- SDK-10: verify() handles v1/v2 with proper validation
- SDK-11: settle() handles v1/v2 with proper validation
- SDK-12: Request body uses validated version
</success_criteria>

<output>
After completion, create `.planning/phases/14-sdk-method-updates/14-01-SUMMARY.md`
</output>

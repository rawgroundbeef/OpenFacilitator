---
phase: 19-chain-preference-logic
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx
  - apps/dashboard/src/components/subscriptions/hooks/use-chain-preference.ts
  - apps/dashboard/src/components/subscriptions/wallet-cards.tsx
autonomous: true

must_haves:
  truths:
    - "User sees toggle between wallet cards with 'Preferred Chain' label"
    - "Toggle shows Base on left, Solana on right"
    - "Toggle instantly reflects preference change (optimistic)"
    - "Preference persists across page refresh"
    - "Toggle is disabled when both wallets don't exist"
  artifacts:
    - path: "apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx"
      provides: "iOS-style toggle component"
      min_lines: 40
      contains: "Switch.Root"
    - path: "apps/dashboard/src/components/subscriptions/hooks/use-chain-preference.ts"
      provides: "Preference state management with optimistic updates"
      exports: ["useChainPreference"]
  key_links:
    - from: "apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx"
      to: "@radix-ui/react-switch"
      via: "import"
      pattern: "import.*Switch.*from.*@radix-ui/react-switch"
    - from: "apps/dashboard/src/components/subscriptions/hooks/use-chain-preference.ts"
      to: "apps/dashboard/src/lib/api.ts"
      via: "api.updateChainPreference call"
      pattern: "api\\.(getChainPreference|updateChainPreference)"
    - from: "apps/dashboard/src/components/subscriptions/wallet-cards.tsx"
      to: "apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx"
      via: "ChainPreferenceToggle import and usage"
      pattern: "ChainPreferenceToggle"
---

<objective>
Create the chain preference toggle UI with optimistic updates and integrate it into the Subscriptions page.

Purpose: Allow users to explicitly set their preferred payment chain via a prominent toggle positioned between the wallet cards.

Output: ChainPreferenceToggle component, useChainPreference hook, and WalletCards integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-chain-preference-logic/19-CONTEXT.md
@.planning/phases/19-chain-preference-logic/19-RESEARCH.md
@.planning/phases/19-chain-preference-logic/19-01-SUMMARY.md

Key context from CONTEXT.md:
- Toggle lives between wallet cards (centered, visually connects them)
- iOS-style sliding switch - Base on left, Solana on right
- Text labels only ("Base" and "Solana"), no logos
- "Preferred Chain" label above the toggle
- No confirmation dialog - toggle flips instantly

Key patterns from RESEARCH.md:
- Radix UI Switch (v1.2.6 already installed) for accessible toggle
- TanStack Query useMutation for optimistic updates
- 'use client' directive required for Radix components
- Disable toggle during mutation to prevent race conditions
- Blue background for Base, purple for Solana
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChainPreferenceToggle component</name>
  <files>
    apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx
  </files>
  <action>
Create new file `apps/dashboard/src/components/subscriptions/chain-preference-toggle.tsx`:

```typescript
'use client';

import * as Switch from '@radix-ui/react-switch';
import { cn } from '@/lib/utils';

interface ChainPreferenceToggleProps {
  preference: 'base' | 'solana';
  onChange: (chain: 'base' | 'solana') => void;
  disabled?: boolean;
}

export function ChainPreferenceToggle({
  preference,
  onChange,
  disabled,
}: ChainPreferenceToggleProps) {
  // Solana = checked state (right side)
  const isSolana = preference === 'solana';

  return (
    <div className="flex flex-col items-center gap-2 py-4">
      <label className="text-sm font-medium text-muted-foreground">
        Preferred Chain
      </label>

      <div className="flex items-center gap-3">
        <span
          className={cn(
            'text-sm font-medium transition-colors duration-200',
            !isSolana ? 'text-foreground' : 'text-muted-foreground'
          )}
        >
          Base
        </span>

        <Switch.Root
          checked={isSolana}
          onCheckedChange={(checked) => onChange(checked ? 'solana' : 'base')}
          disabled={disabled}
          className={cn(
            'relative inline-flex h-8 w-14 items-center rounded-full',
            'transition-colors duration-200 ease-in-out',
            'focus-visible:outline-none focus-visible:ring-2',
            'focus-visible:ring-ring focus-visible:ring-offset-2',
            'disabled:cursor-not-allowed disabled:opacity-50',
            // Blue for Base (unchecked), purple for Solana (checked)
            isSolana ? 'bg-purple-500' : 'bg-blue-500'
          )}
        >
          <Switch.Thumb
            className={cn(
              'pointer-events-none block h-6 w-6 rounded-full',
              'bg-white shadow-lg ring-0',
              'transition-transform duration-200 ease-in-out',
              isSolana ? 'translate-x-7' : 'translate-x-1'
            )}
          />
        </Switch.Root>

        <span
          className={cn(
            'text-sm font-medium transition-colors duration-200',
            isSolana ? 'text-foreground' : 'text-muted-foreground'
          )}
        >
          Solana
        </span>
      </div>

      <p className="text-xs text-muted-foreground mt-1">
        Used for automatic subscription payments
      </p>
    </div>
  );
}
```

Key features:
- Uses Radix UI Switch for accessibility (keyboard nav, ARIA, focus states)
- iOS-style appearance with Tailwind
- Blue for Base (left/unchecked), purple for Solana (right/checked)
- "Preferred Chain" label above
- Helper text below explaining what it's for
- Disabled state support for race condition prevention
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/dashboard/tsconfig.json` - no type errors.
Verify file exists and exports ChainPreferenceToggle.
Check that 'use client' directive is present.
  </verify>
  <done>
ChainPreferenceToggle component exists with Radix Switch, proper styling, accessibility features, and disabled state support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useChainPreference hook with optimistic updates</name>
  <files>
    apps/dashboard/src/components/subscriptions/hooks/use-chain-preference.ts
  </files>
  <action>
Create hooks directory if needed, then create `apps/dashboard/src/components/subscriptions/hooks/use-chain-preference.ts`:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api, type ChainPreference } from '@/lib/api';
import { useToast } from '@/hooks/use-toast';

export function useChainPreference() {
  const queryClient = useQueryClient();
  const { toast } = useToast();

  // Fetch current preference
  const { data, isLoading } = useQuery({
    queryKey: ['chainPreference'],
    queryFn: () => api.getChainPreference(),
  });

  // Update preference with optimistic update
  const mutation = useMutation({
    mutationFn: (chain: 'base' | 'solana') => api.updateChainPreference(chain),

    // Optimistic update - runs immediately before API call
    onMutate: async (newChain) => {
      // Cancel any outgoing refetches to avoid overwriting optimistic update
      await queryClient.cancelQueries({ queryKey: ['chainPreference'] });

      // Snapshot previous value for rollback
      const previousData = queryClient.getQueryData<ChainPreference>(['chainPreference']);

      // Optimistically update to new value
      queryClient.setQueryData<ChainPreference>(['chainPreference'], {
        preferredChain: newChain,
      });

      // Return context with previous data for rollback
      return { previousData };
    },

    // Rollback on error
    onError: (error, _newChain, context) => {
      // Restore previous value
      if (context?.previousData) {
        queryClient.setQueryData(['chainPreference'], context.previousData);
      }

      toast({
        title: 'Failed to update preference',
        description: error instanceof Error ? error.message : 'Please try again.',
        variant: 'destructive',
      });
    },

    // Refetch on success to ensure consistency
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['chainPreference'] });
    },
  });

  return {
    preference: data?.preferredChain ?? 'solana',
    isLoading,
    updatePreference: mutation.mutate,
    isUpdating: mutation.isPending,
  };
}
```

Key features:
- Fetches preference on mount via useQuery
- Optimistic update for instant UI feedback
- Automatic rollback on error with toast notification
- Returns isUpdating for disabling toggle during mutation
- Default to 'solana' if no data yet
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/dashboard/tsconfig.json` - no type errors.
Verify file exports useChainPreference hook.
  </verify>
  <done>
useChainPreference hook exists with optimistic updates, error handling, and loading states.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate toggle into WalletCards component</name>
  <files>
    apps/dashboard/src/components/subscriptions/wallet-cards.tsx
  </files>
  <action>
Update `apps/dashboard/src/components/subscriptions/wallet-cards.tsx` to include the preference toggle:

1. Add imports at top:
```typescript
import { ChainPreferenceToggle } from './chain-preference-toggle';
import { useChainPreference } from './hooks/use-chain-preference';
```

2. Inside WalletCards function, add hook usage after existing hooks:
```typescript
const { preference, isLoading: preferenceLoading, updatePreference, isUpdating } = useChainPreference();
```

3. Determine if both wallets exist for toggle enablement:
```typescript
const bothWalletsExist = !!(baseWallet?.address && solanaWallet?.address);
```

4. Update the JSX to place toggle between the wallet cards. Change the layout from a simple grid to a flex container that can center the toggle:
```typescript
return (
  <div className="space-y-4">
    {/* Wallet Cards Grid */}
    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
      <WalletCard
        network="base"
        address={baseWallet?.address || null}
        balance={baseWallet?.balance || '0.00'}
        isLoading={isLoading}
        isRefreshing={refreshingChain === 'base'}
        onRefresh={() => handleRefresh('base')}
        onCreate={() => createMutation.mutate('base')}
        isCreating={createMutation.isPending && createMutation.variables === 'base'}
      />
      <WalletCard
        network="solana"
        address={solanaWallet?.address || null}
        balance={solanaWallet?.balance || '0.00'}
        isLoading={isLoading}
        isRefreshing={refreshingChain === 'solana'}
        onRefresh={() => handleRefresh('solana')}
        onCreate={() => createMutation.mutate('solana')}
        isCreating={createMutation.isPending && createMutation.variables === 'solana'}
      />
    </div>

    {/* Chain Preference Toggle - between cards conceptually */}
    {bothWalletsExist ? (
      <ChainPreferenceToggle
        preference={preference}
        onChange={updatePreference}
        disabled={isUpdating || preferenceLoading}
      />
    ) : (
      <div className="flex flex-col items-center gap-2 py-4">
        <span className="text-sm text-muted-foreground">
          Create both wallets to set your preferred chain
        </span>
      </div>
    )}
  </div>
);
```

This layout:
- Shows wallet cards in a responsive grid (side by side on desktop, stacked on mobile)
- Places the preference toggle below the cards, centered
- On desktop, this visually "connects" the two cards
- On mobile, toggle appears after stacked cards
- Only shows toggle when both wallets exist
- Shows helpful message when wallets are missing
- Disables toggle during preference update or loading
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/dashboard/tsconfig.json` - no type errors.
Run `npm run dev` in apps/dashboard and visually verify:
1. Toggle appears between/below wallet cards
2. Toggle is disabled when one or both wallets don't exist
3. Toggling updates preference immediately (optimistic)
4. Preference persists after page refresh
  </verify>
  <done>
WalletCards integrates ChainPreferenceToggle with proper conditional rendering and disabled state management.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Toggle renders with correct styling (blue/purple colors, iOS-style)
3. Toggle shows "Preferred Chain" label and "Base"/"Solana" labels
4. Toggle flips instantly on click (optimistic update)
5. Preference persists after page refresh (database persistence)
6. Toggle is disabled when only one wallet exists
7. Error toast appears if API call fails
8. Keyboard navigation works (Tab to focus, Space to toggle)
</verification>

<success_criteria>
- PREF-02: Prominent preference toggle in Subscriptions section - COMPLETE
- Toggle uses Radix Switch with proper accessibility
- Optimistic updates provide instant feedback
- Integration with existing WalletCards component
- Responsive design (desktop and mobile)
</success_criteria>

<output>
After completion, create `.planning/phases/19-chain-preference-logic/19-02-SUMMARY.md`
</output>

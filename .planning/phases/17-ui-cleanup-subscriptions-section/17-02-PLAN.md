---
phase: 17-ui-cleanup-subscriptions-section
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/routes/subscriptions.ts
  - apps/dashboard/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "API returns subscription payment history for authenticated user"
    - "Each payment record includes date, amount, chain, and transaction hash"
    - "Dashboard can fetch payment history via api.getSubscriptionHistory()"
  artifacts:
    - path: "packages/server/src/routes/subscriptions.ts"
      provides: "GET /api/subscriptions/history endpoint"
      exports: ["subscriptionsRouter"]
    - path: "apps/dashboard/src/lib/api.ts"
      provides: "getSubscriptionHistory() method"
      exports: ["api"]
  key_links:
    - from: "packages/server/src/routes/subscriptions.ts"
      to: "packages/server/src/db/subscriptions.ts"
      via: "getSubscriptionsByUserId import"
      pattern: "getSubscriptionsByUserId"
    - from: "apps/dashboard/src/lib/api.ts"
      to: "/api/subscriptions/history"
      via: "fetch request"
      pattern: "/api/subscriptions/history"
---

<objective>
Add API endpoint and client method for fetching subscription payment history.

Purpose: The Subscriptions page needs to display payment history with date, amount, chain, and transaction hash. The database layer already has `getSubscriptionsByUserId()` but no API endpoint exposes it.

Output: New GET /api/subscriptions/history endpoint, updated api.ts with getSubscriptionHistory() method.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-ui-cleanup-subscriptions-section/17-CONTEXT.md
@packages/server/src/routes/subscriptions.ts
@packages/server/src/db/subscriptions.ts
@apps/dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payment history endpoint to subscriptions router</name>
  <files>
    packages/server/src/routes/subscriptions.ts
  </files>
  <action>
Add a new GET /api/subscriptions/history endpoint to the subscriptions router:

1. Import getSubscriptionsByUserId from the db layer (if not already imported):
   ```typescript
   import {
     createSubscription,
     getActiveSubscription,
     getSubscriptionsByUserId,  // Add this
     extendSubscription,
     SUBSCRIPTION_PRICING,
     type SubscriptionTier,
   } from '../db/subscriptions.js';
   ```

2. Add the new endpoint after the /pricing endpoint:
   ```typescript
   /**
    * GET /api/subscriptions/history
    * Get subscription payment history for authenticated user
    * Returns all subscription payments (including expired subscriptions)
    */
   router.get('/history', requireAuth, async (req: Request, res: Response) => {
     try {
       const userId = req.user!.id;

       const subscriptions = getSubscriptionsByUserId(userId);

       // Transform to payment history format
       const payments = subscriptions.map((sub) => ({
         id: sub.id,
         date: sub.created_at,
         amount: (sub.amount / 1_000_000).toFixed(2), // Convert from USDC decimals
         chain: 'solana', // Currently all subscriptions are on Solana
         txHash: sub.tx_hash,
         tier: sub.tier,
         expiresAt: sub.expires_at,
       }));

       res.json({ payments });
     } catch (error) {
       console.error('Get subscription history error:', error);
       res.status(500).json({ error: 'Internal server error' });
     }
   });
   ```

The endpoint returns payments sorted by created_at DESC (from db layer).
  </action>
  <verify>
    - File compiles without TypeScript errors
    - `getSubscriptionsByUserId` is imported
    - Route handler for GET /history exists with requireAuth middleware
  </verify>
  <done>GET /api/subscriptions/history endpoint added with payment transformation</done>
</task>

<task type="auto">
  <name>Task 2: Add getSubscriptionHistory method to API client</name>
  <files>
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
Add types and method to the API client:

1. Add SubscriptionPayment interface near other subscription types (around line 217):
   ```typescript
   export interface SubscriptionPayment {
     id: string;
     date: string;
     amount: string;
     chain: string;
     txHash: string | null;
     tier: string;
     expiresAt: string;
   }

   export interface SubscriptionHistoryResponse {
     payments: SubscriptionPayment[];
   }
   ```

2. Add the getSubscriptionHistory method to ApiClient class (after purchaseSubscription, around line 862):
   ```typescript
   async getSubscriptionHistory(): Promise<SubscriptionHistoryResponse> {
     return this.request('/api/subscriptions/history');
   }
   ```
  </action>
  <verify>
    - TypeScript compiles without errors: `cd apps/dashboard && npx tsc --noEmit`
    - SubscriptionPayment interface exists
    - SubscriptionHistoryResponse interface exists
    - getSubscriptionHistory method exists in ApiClient class
  </verify>
  <done>API client updated with getSubscriptionHistory() method and types</done>
</task>

</tasks>

<verification>
Build check:
```bash
cd packages/server && npm run build
cd apps/dashboard && npm run build
```

Manual API test (with running server and authenticated session):
```bash
# After signing in via browser to get session cookie
curl -X GET http://localhost:5002/api/subscriptions/history \
  -H "Cookie: <session_cookie>" \
  -H "Content-Type: application/json"
```

Expected response format:
```json
{
  "payments": [
    {
      "id": "uuid",
      "date": "2026-01-22T12:00:00Z",
      "amount": "5.00",
      "chain": "solana",
      "txHash": "...",
      "tier": "starter",
      "expiresAt": "2026-02-22T12:00:00Z"
    }
  ]
}
```
</verification>

<success_criteria>
- GET /api/subscriptions/history endpoint exists and requires auth
- Returns array of payments with id, date, amount, chain, txHash, tier, expiresAt
- Amount is formatted as decimal string (e.g., "5.00" not 5000000)
- api.getSubscriptionHistory() method available in dashboard
- Both server and dashboard build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/17-ui-cleanup-subscriptions-section/17-02-SUMMARY.md`
</output>

---
phase: 17-ui-cleanup-subscriptions-section
plan: 03
type: execute
wave: 2
depends_on: ["17-01", "17-02"]
files_modified:
  - apps/dashboard/src/app/subscriptions/page.tsx
  - apps/dashboard/src/components/subscriptions/status-card.tsx
  - apps/dashboard/src/components/subscriptions/billing-card.tsx
  - apps/dashboard/src/components/subscriptions/payment-history.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /subscriptions page"
    - "User sees subscription status (active/inactive/pending/never)"
    - "User sees next billing date when subscribed"
    - "User sees subscription cost ($5/month)"
    - "User sees payment history with date, amount, chain, and transaction hash"
    - "User without subscription sees 'Subscribe' CTA"
  artifacts:
    - path: "apps/dashboard/src/app/subscriptions/page.tsx"
      provides: "Subscriptions page with status, billing, and history"
      min_lines: 80
    - path: "apps/dashboard/src/components/subscriptions/status-card.tsx"
      provides: "Subscription status display card"
      exports: ["StatusCard"]
    - path: "apps/dashboard/src/components/subscriptions/billing-card.tsx"
      provides: "Billing info card with cost and next date"
      exports: ["BillingCard"]
    - path: "apps/dashboard/src/components/subscriptions/payment-history.tsx"
      provides: "Payment history table component"
      exports: ["PaymentHistory"]
  key_links:
    - from: "apps/dashboard/src/app/subscriptions/page.tsx"
      to: "/api/subscriptions/status"
      via: "useQuery for subscription status"
      pattern: "api\\.getSubscriptionStatus"
    - from: "apps/dashboard/src/app/subscriptions/page.tsx"
      to: "/api/subscriptions/history"
      via: "useQuery for payment history"
      pattern: "api\\.getSubscriptionHistory"
    - from: "apps/dashboard/src/components/subscriptions/payment-history.tsx"
      to: "solscan.io"
      via: "transaction hash link"
      pattern: "solscan\\.io/tx"
---

<objective>
Create the Subscriptions page with status display, billing info, and payment history.

Purpose: Users need a dedicated section to view their subscription status, see when their next billing date is, and review their payment history with transaction details.

Output: /subscriptions page with StatusCard, BillingCard, and PaymentHistory components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-ui-cleanup-subscriptions-section/17-CONTEXT.md
@.planning/phases/17-ui-cleanup-subscriptions-section/17-RESEARCH.md
@apps/dashboard/src/app/dashboard/page.tsx
@apps/dashboard/src/app/rewards/page.tsx
@apps/dashboard/src/components/ui/card.tsx
@apps/dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatusCard component</name>
  <files>
    apps/dashboard/src/components/subscriptions/status-card.tsx
  </files>
  <action>
Create the subscription status card component:

```typescript
'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { CheckCircle, Clock, XCircle, AlertCircle } from 'lucide-react';
import type { SubscriptionStatus } from '@/lib/api';

type SubscriptionState = 'active' | 'pending' | 'inactive' | 'never';

function getSubscriptionState(subscription: SubscriptionStatus | null | undefined): SubscriptionState {
  if (!subscription || subscription.tier === null) return 'never';
  if (subscription.active) return 'active';

  // Check if in grace period (7 days after expiration)
  if (subscription.expires) {
    const expiresDate = new Date(subscription.expires);
    const gracePeriodEnd = new Date(expiresDate);
    gracePeriodEnd.setDate(gracePeriodEnd.getDate() + 7);
    if (new Date() < gracePeriodEnd) return 'pending';
  }

  return 'inactive';
}

const statusConfig = {
  active: {
    icon: CheckCircle,
    label: 'Active',
    description: 'Your subscription is active',
    className: 'text-green-600 dark:text-green-400',
    badgeClass: 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400',
  },
  pending: {
    icon: Clock,
    label: 'Pending',
    description: 'Payment pending or in grace period',
    className: 'text-amber-600 dark:text-amber-400',
    badgeClass: 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400',
  },
  inactive: {
    icon: XCircle,
    label: 'Expired',
    description: 'Your subscription has expired',
    className: 'text-red-600 dark:text-red-400',
    badgeClass: 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400',
  },
  never: {
    icon: AlertCircle,
    label: 'Not Subscribed',
    description: 'Subscribe to create facilitators',
    className: 'text-gray-600 dark:text-gray-400',
    badgeClass: 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400',
  },
};

interface StatusCardProps {
  subscription: SubscriptionStatus | null | undefined;
  onSubscribe?: () => void;
  isSubscribing?: boolean;
}

export function StatusCard({ subscription, onSubscribe, isSubscribing }: StatusCardProps) {
  const state = getSubscriptionState(subscription);
  const config = statusConfig[state];
  const Icon = config.icon;

  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle className="text-base font-medium">Subscription Status</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="flex items-center gap-3 mb-4">
          <Icon className={`w-8 h-8 ${config.className}`} />
          <div>
            <span className={`text-xs px-2 py-0.5 rounded-full ${config.badgeClass}`}>
              {config.label}
            </span>
            <p className="text-sm text-muted-foreground mt-1">{config.description}</p>
          </div>
        </div>

        {(state === 'never' || state === 'inactive') && onSubscribe && (
          <Button
            onClick={onSubscribe}
            className="w-full"
            disabled={isSubscribing}
          >
            {isSubscribing ? 'Processing...' : 'Subscribe Now'}
          </Button>
        )}

        {state === 'pending' && (
          <p className="text-sm text-amber-600 dark:text-amber-400">
            Please fund your wallet to continue your subscription.
          </p>
        )}
      </CardContent>
    </Card>
  );
}
```

Creates status display with four states: active (green), pending (amber), inactive/expired (red), never subscribed (gray).
  </action>
  <verify>
    - File exists at correct path
    - Exports StatusCard component
    - Has all four status states with appropriate colors
    - Subscribe button shows for never/inactive states
  </verify>
  <done>StatusCard component created with four subscription states and visual indicators</done>
</task>

<task type="auto">
  <name>Task 2: Create BillingCard component</name>
  <files>
    apps/dashboard/src/components/subscriptions/billing-card.tsx
  </files>
  <action>
Create the billing info card component:

```typescript
'use client';

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Calendar, DollarSign } from 'lucide-react';
import { formatDate } from '@/lib/utils';
import type { SubscriptionStatus } from '@/lib/api';

interface BillingCardProps {
  subscription: SubscriptionStatus | null | undefined;
}

export function BillingCard({ subscription }: BillingCardProps) {
  const hasSubscription = subscription?.tier !== null;
  const nextBillingDate = subscription?.expires
    ? formatDate(subscription.expires)
    : null;

  return (
    <Card>
      <CardHeader className="pb-3">
        <CardTitle className="text-base font-medium">Billing Information</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Subscription Cost */}
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg bg-muted">
            <DollarSign className="w-5 h-5 text-muted-foreground" />
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Subscription Cost</p>
            <p className="text-lg font-semibold">
              $5<span className="text-sm font-normal text-muted-foreground">/month</span>
            </p>
          </div>
        </div>

        {/* Next Billing Date */}
        <div className="flex items-center gap-3">
          <div className="p-2 rounded-lg bg-muted">
            <Calendar className="w-5 h-5 text-muted-foreground" />
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Next Billing Date</p>
            <p className="text-lg font-semibold">
              {hasSubscription && nextBillingDate
                ? nextBillingDate
                : <span className="text-muted-foreground font-normal">—</span>
              }
            </p>
          </div>
        </div>

        {/* Payment Method Note */}
        <p className="text-xs text-muted-foreground pt-2 border-t">
          Payments are processed from your subscription wallet in USDC on Solana.
        </p>
      </CardContent>
    </Card>
  );
}
```

Shows $5/month subscription cost and next billing date. Note about USDC on Solana.
  </action>
  <verify>
    - File exists at correct path
    - Exports BillingCard component
    - Shows $5/month pricing
    - Shows next billing date when subscribed
    - Shows dash when not subscribed
  </verify>
  <done>BillingCard component created showing cost and next billing date</done>
</task>

<task type="auto">
  <name>Task 3: Create PaymentHistory component</name>
  <files>
    apps/dashboard/src/components/subscriptions/payment-history.tsx
  </files>
  <action>
Create the payment history table component:

```typescript
'use client';

import { ExternalLink } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { formatDate } from '@/lib/utils';
import type { SubscriptionPayment } from '@/lib/api';

function truncateTxHash(hash: string): string {
  return `${hash.slice(0, 6)}...${hash.slice(-4)}`;
}

function getExplorerUrl(txHash: string, chain: string): string {
  // Currently only Solana supported - Phase 18 adds Base
  if (chain === 'base') {
    return `https://basescan.org/tx/${txHash}`;
  }
  return `https://solscan.io/tx/${txHash}`;
}

interface PaymentHistoryProps {
  payments: SubscriptionPayment[];
  isLoading?: boolean;
}

export function PaymentHistory({ payments, isLoading }: PaymentHistoryProps) {
  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle className="text-base font-medium">Payment History</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-12 bg-muted rounded animate-pulse" />
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="text-base font-medium">Payment History</CardTitle>
      </CardHeader>
      <CardContent>
        {payments.length === 0 ? (
          <p className="text-sm text-muted-foreground text-center py-8">
            No payment history yet.
          </p>
        ) : (
          <div className="border rounded-lg overflow-hidden">
            <table className="w-full text-sm">
              <thead className="bg-muted/50">
                <tr>
                  <th className="text-left py-3 px-4 font-medium text-muted-foreground">Date</th>
                  <th className="text-right py-3 px-4 font-medium text-muted-foreground">Amount</th>
                  <th className="text-left py-3 px-4 font-medium text-muted-foreground">Chain</th>
                  <th className="text-right py-3 px-4 font-medium text-muted-foreground">Transaction</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-border">
                {payments.map((payment) => (
                  <tr key={payment.id} className="hover:bg-muted/30 transition-colors">
                    <td className="py-3 px-4">
                      {formatDate(payment.date)}
                    </td>
                    <td className="py-3 px-4 text-right font-mono">
                      ${payment.amount}
                    </td>
                    <td className="py-3 px-4 capitalize">
                      {payment.chain}
                    </td>
                    <td className="py-3 px-4 text-right">
                      {payment.txHash ? (
                        <a
                          href={getExplorerUrl(payment.txHash, payment.chain)}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center gap-1 text-muted-foreground hover:text-foreground transition-colors"
                        >
                          <code className="font-mono text-xs">
                            {truncateTxHash(payment.txHash)}
                          </code>
                          <ExternalLink className="w-3 h-3" />
                        </a>
                      ) : (
                        <span className="text-muted-foreground">—</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Table-based layout with date, amount, chain, and clickable transaction hash linking to block explorer.
  </action>
  <verify>
    - File exists at correct path
    - Exports PaymentHistory component
    - Renders table with Date, Amount, Chain, Transaction columns
    - Transaction hashes link to Solscan (or Basescan for Base)
    - Empty state message when no payments
    - Loading state with skeleton
  </verify>
  <done>PaymentHistory component created with table layout and explorer links</done>
</task>

<task type="auto">
  <name>Task 4: Create Subscriptions page</name>
  <files>
    apps/dashboard/src/app/subscriptions/page.tsx
  </files>
  <action>
Create the main Subscriptions page:

```typescript
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Loader2 } from 'lucide-react';
import { Navbar } from '@/components/navbar';
import { StatusCard } from '@/components/subscriptions/status-card';
import { BillingCard } from '@/components/subscriptions/billing-card';
import { PaymentHistory } from '@/components/subscriptions/payment-history';
import { useAuth } from '@/components/auth/auth-provider';
import { useToast } from '@/hooks/use-toast';
import { api } from '@/lib/api';

export default function SubscriptionsPage() {
  const router = useRouter();
  const queryClient = useQueryClient();
  const { isAuthenticated, isLoading: authLoading } = useAuth();
  const { toast } = useToast();

  // Redirect if not authenticated
  useEffect(() => {
    if (!authLoading && !isAuthenticated) {
      router.push('/auth/signin');
    }
  }, [authLoading, isAuthenticated, router]);

  // Fetch subscription status
  const { data: subscription, isLoading: statusLoading } = useQuery({
    queryKey: ['subscription'],
    queryFn: () => api.getSubscriptionStatus(),
    enabled: isAuthenticated,
  });

  // Fetch payment history
  const { data: historyData, isLoading: historyLoading } = useQuery({
    queryKey: ['subscriptionHistory'],
    queryFn: () => api.getSubscriptionHistory(),
    enabled: isAuthenticated,
  });

  // Purchase subscription mutation
  const purchaseMutation = useMutation({
    mutationFn: () => api.purchaseSubscription(),
    onSuccess: (result) => {
      if (result.success) {
        toast({
          title: 'Subscription activated!',
          description: 'Your subscription is now active.',
        });
        queryClient.invalidateQueries({ queryKey: ['subscription'] });
        queryClient.invalidateQueries({ queryKey: ['subscriptionHistory'] });
        queryClient.invalidateQueries({ queryKey: ['billingWallet'] });
      } else if (result.insufficientBalance) {
        toast({
          title: 'Insufficient balance',
          description: `You need $${result.required} but only have $${result.available}. Please fund your wallet.`,
          variant: 'destructive',
        });
      } else {
        toast({
          title: 'Purchase failed',
          description: result.error || 'Something went wrong. Please try again.',
          variant: 'destructive',
        });
      }
    },
    onError: (error) => {
      toast({
        title: 'Purchase failed',
        description: error instanceof Error ? error.message : 'Something went wrong',
        variant: 'destructive',
      });
    },
  });

  // Loading state
  if (authLoading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <Loader2 className="w-8 h-8 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (!isAuthenticated) {
    return null;
  }

  return (
    <div className="min-h-screen bg-background">
      <Navbar />

      <main className="max-w-4xl mx-auto px-6 pt-24 pb-20">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-3xl font-bold">Subscriptions</h1>
          <p className="text-muted-foreground mt-1">
            Manage your subscription and view payment history.
          </p>
        </div>

        {/* Status and Billing Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <StatusCard
            subscription={subscription}
            onSubscribe={() => purchaseMutation.mutate()}
            isSubscribing={purchaseMutation.isPending}
          />
          <BillingCard subscription={subscription} />
        </div>

        {/* Payment History */}
        <PaymentHistory
          payments={historyData?.payments || []}
          isLoading={historyLoading}
        />
      </main>
    </div>
  );
}
```

Layout follows existing dashboard patterns:
- Navbar at top
- max-w-4xl centered content
- Header with title and description
- Two-column grid for status/billing cards
- Full-width payment history below
  </action>
  <verify>
    - `npm run build` in apps/dashboard succeeds
    - Page accessible at /subscriptions route
    - Fetches subscription status and payment history
    - Subscribe button triggers purchase mutation
    - Toast notifications on success/failure
    - Redirect to signin if not authenticated
  </verify>
  <done>Subscriptions page created with status, billing, and payment history sections</done>
</task>

</tasks>

<verification>
Build check:
```bash
cd apps/dashboard && npm run build
```

Visual verification (with dev server):
1. Navigate to /subscriptions (authenticated)
2. Verify StatusCard shows correct state (active/pending/inactive/never)
3. Verify BillingCard shows $5/month and next billing date
4. Verify PaymentHistory shows payments with links to Solscan
5. If not subscribed, verify Subscribe button works
6. Test redirect to signin when not authenticated
</verification>

<success_criteria>
- /subscriptions page exists and is accessible
- StatusCard displays four distinct states with appropriate colors
- BillingCard shows $5/month cost and next billing date
- PaymentHistory table shows date, amount, chain, tx hash with explorer links
- Subscribe button functional for non-subscribed users
- Auth redirect works
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/17-ui-cleanup-subscriptions-section/17-03-SUMMARY.md`
</output>

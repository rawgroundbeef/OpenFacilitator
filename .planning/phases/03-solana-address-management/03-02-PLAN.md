---
phase: 03-solana-address-management
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/lib/solana/verification.ts
  - apps/dashboard/src/components/rewards/enrollment-modal.tsx
  - apps/dashboard/src/components/rewards/address-list.tsx
  - apps/dashboard/src/components/rewards/address-card.tsx
  - apps/dashboard/src/components/rewards-info-banner.tsx
  - packages/server/src/routes/rewards.ts
autonomous: false

must_haves:
  truths:
    - "User can click rewards banner to open enrollment modal"
    - "User can connect Solana wallet and sign verification message"
    - "Successful enrollment shows success modal and updates address list"
    - "User can see list of registered addresses with verification status"
    - "User can remove an address from their account"
  artifacts:
    - path: "apps/dashboard/src/components/rewards/enrollment-modal.tsx"
      provides: "Enrollment flow with wallet connection"
      exports: ["EnrollmentModal"]
    - path: "apps/dashboard/src/components/rewards/address-list.tsx"
      provides: "Address list display"
      exports: ["AddressList"]
    - path: "apps/dashboard/src/components/rewards/address-card.tsx"
      provides: "Individual address display"
      exports: ["AddressCard"]
    - path: "apps/dashboard/src/lib/solana/verification.ts"
      provides: "Client-side message creation"
      exports: ["createVerificationMessage", "signAndEnroll"]
  key_links:
    - from: "apps/dashboard/src/components/rewards-info-banner.tsx"
      to: "enrollment-modal.tsx"
      via: "opens modal on click"
      pattern: "EnrollmentModal"
    - from: "apps/dashboard/src/components/rewards/enrollment-modal.tsx"
      to: "lib/solana/verification.ts"
      via: "calls signAndEnroll"
      pattern: "signAndEnroll"
    - from: "apps/dashboard/src/components/rewards/address-list.tsx"
      to: "lib/api.ts"
      via: "fetches addresses from status"
      pattern: "getRewardsStatus"
---

<objective>
Build the complete enrollment flow UI: modal with wallet connection, address list view, and address removal capability.

Purpose: Enable users to register and verify Solana pay-to addresses through a polished UI flow that matches the atomic connect-sign-save pattern specified in CONTEXT.md.

Output: Enrollment modal, address list component, address card component, updated rewards banner as entry point.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-solana-address-management/03-CONTEXT.md
@.planning/phases/03-solana-address-management/03-RESEARCH.md
@.planning/phases/03-solana-address-management/03-01-SUMMARY.md

# Existing patterns
@apps/dashboard/src/components/auth/auth-provider.tsx
@apps/dashboard/src/components/rewards-info-banner.tsx
@apps/dashboard/src/lib/api.ts
@apps/dashboard/src/components/ui/dialog.tsx
@apps/dashboard/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client-side verification utility and update API client</name>
  <files>
    apps/dashboard/src/lib/solana/verification.ts
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
1. Create `apps/dashboard/src/lib/solana/verification.ts`:

   ```typescript
   'use client';

   import { WalletContextState } from '@solana/wallet-adapter-react';
   import bs58 from 'bs58';
   import { api } from '@/lib/api';

   /**
    * Create the verification message for a Solana address.
    * MUST match server-side createVerificationMessage exactly.
    */
   export function createVerificationMessage(address: string): string {
     return `OpenFacilitator Rewards

   Sign to verify ownership of:
   ${address}

   This will not cost any SOL.`;
   }

   /**
    * Sign verification message and enroll address.
    * Combines wallet signing with API enrollment in atomic flow.
    */
   export async function signAndEnroll(
     wallet: WalletContextState
   ): Promise<{ success: boolean; error?: string }> {
     if (!wallet.publicKey) {
       return { success: false, error: 'Wallet not connected' };
     }

     if (!wallet.signMessage) {
       return { success: false, error: 'Wallet does not support message signing' };
     }

     const address = wallet.publicKey.toBase58();
     const message = createVerificationMessage(address);

     try {
       // Sign the message
       const messageBytes = new TextEncoder().encode(message);
       const signatureBytes = await wallet.signMessage(messageBytes);
       const signature = bs58.encode(signatureBytes);

       // Enroll with signature
       await api.enrollInRewards({
         chain_type: 'solana',
         address,
         signature,
         message,
       });

       return { success: true };
     } catch (error) {
       const errorMessage = error instanceof Error ? error.message : 'Unknown error';
       return { success: false, error: errorMessage };
     }
   }
   ```

2. Update `apps/dashboard/src/lib/api.ts`:

   a. Update RewardsEnrollResponse interface (no changes needed - already correct)

   b. Update enrollInRewards method signature to accept signature and message:
      ```typescript
      async enrollInRewards(data: {
        chain_type: 'solana' | 'evm';
        address: string;
        signature: string;
        message: string;
      }): Promise<RewardsEnrollResponse>
      ```
      (Update the existing method body to pass all fields in JSON.stringify)
  </action>
  <verify>
    - TypeScript compiles: `cd apps/dashboard && pnpm build`
    - Functions exported from lib/solana/verification.ts
  </verify>
  <done>
    - createVerificationMessage matches server format exactly
    - signAndEnroll handles wallet signing and API call
    - API client updated to send signature and message
  </done>
</task>

<task type="auto">
  <name>Task 2: Build enrollment modal and address components</name>
  <files>
    apps/dashboard/src/components/rewards/enrollment-modal.tsx
    apps/dashboard/src/components/rewards/address-list.tsx
    apps/dashboard/src/components/rewards/address-card.tsx
  </files>
  <action>
1. Create `apps/dashboard/src/components/rewards/enrollment-modal.tsx`:

   'use client' directive.

   **Imports:**
   - Dialog, DialogContent, DialogHeader, DialogTitle from @/components/ui/dialog
   - Button from @/components/ui/button
   - useWallet from @solana/wallet-adapter-react
   - useWalletModal from @solana/wallet-adapter-react-ui
   - useState, useCallback
   - signAndEnroll from @/lib/solana/verification
   - useAuth from @/components/auth/auth-provider
   - Loader2, CheckCircle, AlertCircle, Wallet from lucide-react

   **Props:**
   ```typescript
   interface EnrollmentModalProps {
     open: boolean;
     onOpenChange: (open: boolean) => void;
   }
   ```

   **State:**
   - status: 'idle' | 'connecting' | 'signing' | 'success' | 'error'
   - errorMessage: string | null

   **Logic:**
   - Get wallet state: `const { publicKey, connected, signMessage } = useWallet()`
   - Get wallet modal: `const { setVisible } = useWalletModal()`
   - Get auth context: `const { refetchRewardsStatus } = useAuth()`

   - `handleConnect`: Opens wallet modal (`setVisible(true)`)

   - `handleSign`: When wallet connected, sign and enroll:
     ```typescript
     setStatus('signing');
     const result = await signAndEnroll(wallet);
     if (result.success) {
       await refetchRewardsStatus(); // Update auth context
       setStatus('success');
     } else {
       setErrorMessage(result.error || 'Failed to verify address');
       setStatus('error');
     }
     ```

   - When wallet connects (`useEffect` watching `connected`), if status is 'connecting', trigger sign flow

   - Reset state when modal closes

   **UI States:**
   - idle: "Connect your pay-to wallet to register for rewards" + Connect Wallet button
   - connecting: Spinner + "Connecting wallet..."
   - signing: Spinner + "Please sign the message in your wallet..."
   - success: CheckCircle icon + "Address added! Your volume will now be tracked." + "Add Another" and "Done" buttons
   - error: AlertCircle icon + errorMessage + "Try Again" button

   **Dialog styling:**
   - Max width sm/md
   - Center content
   - Use existing dialog component patterns

2. Create `apps/dashboard/src/components/rewards/address-card.tsx`:

   'use client' directive.

   **Props:**
   ```typescript
   interface AddressCardProps {
     address: {
       id: string;
       address: string;
       chain_type: 'solana' | 'evm';
       verification_status: 'pending' | 'verified';
       created_at: string;
     };
     onRemove?: (id: string) => void;
     isRemoving?: boolean;
   }
   ```

   **UI:**
   - Card layout with border
   - Left side: Chain icon (use Wallet icon for Solana), truncated address (first 6...last 4 chars)
   - Right side: Verification badge (green "Verified" or yellow "Pending"), date added
   - If onRemove provided: X button to remove (with confirmation or direct removal)
   - Show "Removing..." state when isRemoving is true

3. Create `apps/dashboard/src/components/rewards/address-list.tsx`:

   'use client' directive.

   **Imports:**
   - useAuth from @/components/auth/auth-provider
   - AddressCard
   - Button
   - useState for removal state
   - api from @/lib/api
   - Plus icon from lucide-react

   **Props:**
   ```typescript
   interface AddressListProps {
     onAddAddress: () => void; // Opens enrollment modal
   }
   ```

   **Logic:**
   - Get addresses from auth context (need to extend auth context to include addresses OR fetch directly)
   - Actually, RewardsStatus already includes addresses array - use api.getRewardsStatus() directly or pass addresses as prop
   - Better approach: Fetch addresses with useMutation/useQuery pattern

   Simpler: Use auth context's refetch and pass addresses from parent.

   Let's use a different approach - make AddressList accept addresses as props:
   ```typescript
   interface AddressListProps {
     addresses: RewardsStatus['addresses'];
     onAddAddress: () => void;
     onAddressRemoved: () => void; // Callback to refetch after removal
   }
   ```

   **Removal logic:**
   - State: removingId: string | null
   - handleRemove(id):
     - Set removingId
     - Call api.deleteRewardAddress(id) - WAIT: We need to add this endpoint/method

   NOTE: Need to add DELETE endpoint for addresses. Add to this task.

   **UI:**
   - Header: "Registered Addresses" + "Add Address" button (calls onAddAddress)
   - If no addresses: Empty state - "No addresses registered yet"
   - Map addresses to AddressCard components
   - Pass onRemove and isRemoving to each card
  </action>
  <verify>
    - TypeScript compiles: `cd apps/dashboard && pnpm build`
    - Components export correctly from their files
  </verify>
  <done>
    - EnrollmentModal handles full flow: connect -> sign -> success/error
    - AddressCard displays address info with remove capability
    - AddressList shows all addresses with add/remove actions
  </done>
</task>

<task type="auto">
  <name>Task 3: Add address deletion endpoint and API client method</name>
  <files>
    packages/server/src/routes/rewards.ts
    apps/dashboard/src/lib/api.ts
  </files>
  <action>
1. Add DELETE endpoint to `packages/server/src/routes/rewards.ts`:

   ```typescript
   /**
    * DELETE /addresses/:id
    * Remove a reward address from user's account
    */
   router.delete('/addresses/:id', requireAuth, async (req: Request, res: Response) => {
     try {
       const userId = req.user!.id;
       const addressId = req.params.id;

       // Verify ownership - get address and check user_id matches
       const address = getRewardAddressById(addressId);

       if (!address) {
         res.status(404).json({
           error: 'Not found',
           message: 'Address not found',
         });
         return;
       }

       if (address.user_id !== userId) {
         res.status(403).json({
           error: 'Forbidden',
           message: 'You can only remove your own addresses',
         });
         return;
       }

       const deleted = deleteRewardAddress(addressId);

       if (!deleted) {
         res.status(500).json({
           error: 'Internal server error',
           message: 'Failed to delete address',
         });
         return;
       }

       res.status(204).send();
     } catch (error) {
       console.error('Error deleting reward address:', error);
       res.status(500).json({
         error: 'Internal server error',
         message: 'Failed to delete address',
       });
     }
   });
   ```

   Add imports at top if not present:
   - `getRewardAddressById` from '../db/reward-addresses.js'
   - `deleteRewardAddress` from '../db/reward-addresses.js'

2. Add API client method to `apps/dashboard/src/lib/api.ts`:

   ```typescript
   async deleteRewardAddress(addressId: string): Promise<void> {
     return this.request(`/api/rewards/addresses/${addressId}`, {
       method: 'DELETE',
     });
   }
   ```

   Add this method in the ApiClient class, near the other rewards methods.
  </action>
  <verify>
    - Server builds: `cd packages/server && pnpm build`
    - Dashboard builds: `cd apps/dashboard && pnpm build`
    - Endpoint accessible (will test during verification checkpoint)
  </verify>
  <done>
    - DELETE /api/rewards/addresses/:id endpoint exists
    - Ownership verified before deletion
    - API client has deleteRewardAddress method
  </done>
</task>

<task type="auto">
  <name>Task 4: Update rewards banner and wire up complete flow</name>
  <files>
    apps/dashboard/src/components/rewards-info-banner.tsx
    apps/dashboard/src/app/dashboard/page.tsx
  </files>
  <action>
1. Update `apps/dashboard/src/components/rewards-info-banner.tsx`:

   Complete rewrite to support enrollment flow:

   ```typescript
   'use client';

   import { useState, useEffect } from 'react';
   import { useAuth } from '@/components/auth/auth-provider';
   import { Button } from '@/components/ui/button';
   import { EnrollmentModal } from '@/components/rewards/enrollment-modal';
   import { AddressList } from '@/components/rewards/address-list';
   import { api, type RewardsStatus } from '@/lib/api';
   import { ChevronDown, ChevronUp, Wallet } from 'lucide-react';

   export function RewardsInfoBanner() {
     const { isAuthenticated, isEnrolled, isFacilitatorOwner, refetchRewardsStatus } = useAuth();
     const [enrollmentOpen, setEnrollmentOpen] = useState(false);
     const [addresses, setAddresses] = useState<RewardsStatus['addresses']>([]);
     const [expanded, setExpanded] = useState(false);

     // Fetch addresses when component mounts or enrollment changes
     useEffect(() => {
       if (isAuthenticated) {
         api.getRewardsStatus().then((status) => {
           setAddresses(status.addresses);
         }).catch(console.error);
       }
     }, [isAuthenticated, isEnrolled]);

     const handleAddressRemoved = async () => {
       // Refetch addresses after removal
       const status = await api.getRewardsStatus();
       setAddresses(status.addresses);
       await refetchRewardsStatus();
     };

     const handleEnrollmentClose = async (open: boolean) => {
       setEnrollmentOpen(open);
       if (!open) {
         // Refetch when modal closes (in case address was added)
         const status = await api.getRewardsStatus();
         setAddresses(status.addresses);
       }
     };

     // Don't show if not authenticated
     if (!isAuthenticated) return null;

     // If enrolled, show address management section
     if (isEnrolled) {
       return (
         <div className="mb-6 p-4 rounded-lg border border-primary/20 bg-primary/5">
           <div className="flex items-center justify-between">
             <div className="flex items-center gap-2">
               <Wallet className="h-5 w-5 text-primary" />
               <h3 className="font-semibold text-primary">Rewards Program</h3>
               <span className="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-0.5 rounded">
                 Enrolled
               </span>
             </div>
             <Button
               variant="ghost"
               size="sm"
               onClick={() => setExpanded(!expanded)}
             >
               {expanded ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
               <span className="ml-1">{addresses.length} address{addresses.length !== 1 ? 'es' : ''}</span>
             </Button>
           </div>

           {expanded && (
             <div className="mt-4 pt-4 border-t border-primary/10">
               <AddressList
                 addresses={addresses}
                 onAddAddress={() => setEnrollmentOpen(true)}
                 onAddressRemoved={handleAddressRemoved}
               />
             </div>
           )}

           <EnrollmentModal
             open={enrollmentOpen}
             onOpenChange={handleEnrollmentClose}
           />
         </div>
       );
     }

     // Not enrolled - show enrollment CTA
     return (
       <div className="mb-6 p-4 rounded-lg border border-primary/20 bg-primary/5">
         <div className="flex items-start justify-between">
           <div>
             <h3 className="font-semibold text-primary">Earn $OPEN Rewards</h3>
             <p className="text-sm text-muted-foreground mt-1">
               {isFacilitatorOwner
                 ? "Your facilitator volume qualifies for rewards! Register your pay-to address to start tracking."
                 : "Track payment volume and earn $OPEN tokens. Connect your pay-to wallet to get started."}
             </p>
           </div>
           <Button onClick={() => setEnrollmentOpen(true)}>
             Get Started
           </Button>
         </div>

         <EnrollmentModal
           open={enrollmentOpen}
           onOpenChange={handleEnrollmentClose}
         />
       </div>
     );
   }
   ```

2. The dashboard page already includes RewardsInfoBanner - no changes needed to page.tsx unless the component import path changed.

3. Ensure all imports are correct and components are exported properly.
  </action>
  <verify>
    - Dashboard builds: `cd apps/dashboard && pnpm build`
    - Dashboard starts: `cd apps/dashboard && pnpm dev`
    - Banner visible on dashboard for non-enrolled users
    - "Get Started" button opens enrollment modal
  </verify>
  <done>
    - Rewards banner shows enrollment CTA for non-enrolled users
    - Enrolled users see address list with management options
    - Enrollment modal integrated and functional
    - Complete flow wired: banner -> modal -> sign -> success -> list
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Solana address enrollment and management flow:
    - Wallet connection via Solana wallet adapter
    - Message signing for address verification
    - Address list display with removal capability
    - Enrollment modal with success/error states
  </what-built>
  <how-to-verify>
    1. Start the dev server: `cd apps/dashboard && pnpm dev`
    2. Start the API server: `cd packages/server && pnpm dev`
    3. Navigate to http://localhost:5001
    4. Sign in (or create account if needed)
    5. On dashboard, you should see "Earn $OPEN Rewards" banner
    6. Click "Get Started" button
    7. Click "Connect Wallet" in the modal
    8. Select Phantom (or another Solana wallet) from the wallet modal
    9. Approve the connection in your wallet
    10. Sign the verification message when prompted
    11. You should see "Address added! Your volume will now be tracked."
    12. Click "Done" to close modal
    13. Banner should now show "Enrolled" with your address listed
    14. Expand the address list and verify your address appears
    15. Try removing the address (should remove successfully)
    16. Try adding another address via "Add Address" button

    Expected behavior:
    - Wallet connection modal appears (standard Solana wallet UI)
    - Signing request appears in wallet with message "Sign to verify ownership of..."
    - After signing, address is immediately verified (green "Verified" badge)
    - Address can be removed from list
    - Adding multiple addresses works up to limit of 5
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Full enrollment flow works end-to-end
2. Wallet connection uses standard adapter UI
3. Signature verification rejects invalid signatures
4. Address list updates after add/remove
5. UI states (loading, success, error) display correctly
6. Mobile responsive (modal, banner, cards)
</verification>

<success_criteria>
- User can add Solana address via wallet connection and signing
- Addresses appear immediately as "Verified" (atomic flow)
- User can view and remove addresses
- Banner transforms from CTA to management view when enrolled
- Error states handled gracefully with retry option
- Limit of 5 addresses enforced with clear message
</success_criteria>

<output>
After completion, create `.planning/phases/03-solana-address-management/03-02-SUMMARY.md`
</output>
